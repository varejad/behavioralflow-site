<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Treinando meu agente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html">Simulação</a>
    <a href="sobre.html">Sobre o Projeto</a>
    <a href="treine.html" class="active">Treine seu Agente</a>
  </nav>

  <h1>Treine seu Agente</h1>

  <main>
    <div>
      <div id="simContainer">
        <!-- O canvas será criado e inserido aqui pelo p5.js -->
      </div>

      <!-- <button id="startBtn" onclick="updateAgentsFromPyodide();">Iniciar Simulação</button> -->
    
      <div id="controls">
        <button onclick="Reflect.get(agent, 'reforcar')(3)">Recompensa!</button>
        <button onclick="Reflect.get(agent, 'reforcar')(-3);">Punição!</button>
      </div>
    </div>
  </main>

  <!-- Scripts externos: carregam primeiro -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  <!-- Seu código -->
  <script>
    async function init() {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip")

      try {
        const code = `
import micropip
await micropip.install("behavioralflow")
import time
from behavioralflow.core import Aprendente

PASSOS_POR_SEGUNDO = 20  # 1 segundo = 20 passos (com loop de 0.05s)

WIDTH = 400
HEIGHT = 400

responses = {("cima",):[0,6],
             ("baixo",):[0,6],
             ("esq",):[0,6],
             ("dir",):[0,6],
             ("parado",):[0,6]}

class Agents(Aprendente):
    def __init__(self, acoes, variar=False, prob_variacao=0.25, positionX = 0, positionY = 0, angle = 0, color="#000000"):
        super().__init__(acoes, variar, prob_variacao)
        self.positionX = positionX
        self.positionY = positionY
        #self.angle = angle # servia para definir para onde o agente está 'virado'
        self.passos_restantes = 0
        self.color = color
        self.circle_color = "#ffffff"
        self.previousPositionX = positionX
        self.previousPositionY = positionY
        self.reinforcement = 0
    
    def set_context(self):
        context = ("sem contexto",)
        return context

    # Executa as ações
    def to_respond(self, context):
        if self.passos_restantes == 0:
            self.circle_color = "#FFFFFF"
            self.proxima_acao(context)
            self.passos_restantes = PASSOS_POR_SEGUNDO

        # Executa a ação atual
        if self._acao_atual[0] == "cima":
            self.positionY = (self.positionY - 1) % HEIGHT
        
        elif self._acao_atual[0] == "baixo":
            self.positionY = (self.positionY + 1) % HEIGHT
        
        elif self._acao_atual[0] == "esq":
            self.positionX = (self.positionX - 1) % WIDTH
        
        elif self._acao_atual[0] == "dir":
            self.positionX = (self.positionX + 1) % WIDTH
        
        elif self._acao_atual[0] == "parado":
            self.positionX += 0
            self.positionY += 0
        
        #diminue um passo
        self.passos_restantes -= 1
    
    def set_consequence(self):
      if self.reinforcement != 0:
          self.reforcar(self.reinforcement)
      
      self.reinforcement = 0

# Criando dois agentes
agents = [
    Agents(responses, prob_variacao=0.0, positionX=50, positionY=50, color="#5690E6"),
]

# Loop de simulação
def simular_em_loop():
    for agent in agents:
        agent.previousPositionY = agent.positionY
        agent.previousPositionX = agent.positionX
        context = agent.set_context()
        agent.to_respond(context)
        agent.set_consequence()
    #time.sleep(1/PASSOS_POR_SEGUNDO)  # PASSOS_POR_SEGUNDO = 20, logo 50ms por passo

        `;
        await pyodide.runPythonAsync(code);

      } catch (err) {
        console.error("Erro ao rodar código Python:", err);
      }
      // Torna acessível no escopo global
      window.pyodide = pyodide;

      setInitialConditions();
    }

    init();

  </script>

  <script src="treine-sketch.js"></script>
</body>
</html>
