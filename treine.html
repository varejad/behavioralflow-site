<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Treinando meu agente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html">Simula√ß√£o</a>
    <a href="sobre.html">Sobre o Projeto</a>
    <a href="treine.html" class="active">Treine seu Agente</a>
  </nav>

  <h1>Treine seu Agente</h1>

  <main>
     <!-- Indicador de carregamento -->
    <div id="loading">
      <p>Carregando, por favor aguarde...</p>
    </div>

    <!-- Interface principal (escondida inicialmente) -->
    <div id="main">
      <div id="simContainer">
        <!-- O canvas ser√° criado e inserido aqui pelo p5.js -->
      </div>
      <div id="controls">
        <!-- tentar fazer usando codigo pyodide sincrono -->
        <!-- tentar fazer indicando no metodo consequence a quantidade de reforco -->
        <button onclick="Reflect.get(agent, 'reforcar')(3)">Recompensa!</button>
        <button onclick="Reflect.get(agent, 'reforcar')(-3);">Puni√ß√£o!</button>
      </div>
    </div>

    <!-- Bot√£o de in√≠cio (escondido at√© carregar) -->
    <div id="setAgent" style="text-align: center; margin-top: 1em; display: none;">
      <label for="agentColor">Cor do agente:</label>
      <input type="color" id="agentColor" name="agentColor" value="#5690E6">

      <br><br>

      <label for="agentName">Nome do agente:</label>
      <input type="text" id="agentName" name="agentName" placeholder="Digite um nome">

      <br><br>

      <button id="startBtn" onclick="setInitialConditionsAndStart();">
        üöÄ Iniciar 
      </button>
    </div>

  </main>

  <!-- Scripts externos: carregam primeiro -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

  <!-- Seu c√≥digo -->
  <script>
    async function init() {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("micropip")

      try {
        const code = `
import micropip
await micropip.install("behavioralflow")
import time
from behavioralflow.core import Aprendente

PASSOS_POR_SEGUNDO = 20  # 1 segundo = 20 passos (com loop de 0.05s)

WIDTH = 400
HEIGHT = 400

responses = {("cima",):[0,6],
             ("baixo",):[0,6],
             ("esq",):[0,6],
             ("dir",):[0,6],
             ("parado",):[0,6]}

class Agents(Aprendente):
    def __init__(self, acoes, variar=False, prob_variacao=0.25, positionX = 0, positionY = 0, angle = 0, color="#000000", name = ""):
        super().__init__(acoes, variar, prob_variacao)
        self.positionX = positionX
        self.positionY = positionY
        #self.angle = angle # servia para definir para onde o agente est√° 'virado'
        self.passos_restantes = 0
        self.color = color
        self.circle_color = "#ffffff"
        self.previousPositionX = positionX
        self.previousPositionY = positionY
        self.name = ""
    
    def set_context(self):
        context = ("sem contexto",)
        return context

    # Executa as a√ß√µes
    def to_respond(self, context):
        if self.passos_restantes == 0:
            self.circle_color = "#FFFFFF"
            self.proxima_acao(context)
            self.passos_restantes = PASSOS_POR_SEGUNDO

        # Executa a a√ß√£o atual
        if self._acao_atual[0] == "cima":
            self.positionY = (self.positionY - 1) % HEIGHT
        
        elif self._acao_atual[0] == "baixo":
            self.positionY = (self.positionY + 1) % HEIGHT
        
        elif self._acao_atual[0] == "esq":
            self.positionX = (self.positionX - 1) % WIDTH
        
        elif self._acao_atual[0] == "dir":
            self.positionX = (self.positionX + 1) % WIDTH
        
        elif self._acao_atual[0] == "parado":
            self.positionX += 0
            self.positionY += 0
        
        #diminue um passo
        self.passos_restantes -= 1
    
    def set_consequence(self):
      pass

# Criando dois agentes
#agents = [
#    Agents(responses, prob_variacao=0.0, positionX=50, positionY=50, color="#5690E6"),
#]

# Loop de simula√ß√£o
def simular_em_loop():
    for agent in agents:
        agent.previousPositionY = agent.positionY
        agent.previousPositionX = agent.positionX
        context = agent.set_context()
        agent.to_respond(context)
        agent.set_consequence()
    #time.sleep(1/PASSOS_POR_SEGUNDO)  # PASSOS_POR_SEGUNDO = 20, logo 50ms por passo

        `;
        await pyodide.runPythonAsync(code);

      } catch (err) {
        console.error("Erro ao rodar c√≥digo Python:", err);
      }
      // Torna acess√≠vel no escopo global
      window.pyodide = pyodide;

      // Tudo carregado ‚Äî esconder "Carregando..." e mostrar bot√£o de iniciar
      document.getElementById("loading").style.display = "none";
      document.getElementById("setAgent").style.display = "block";
    }

    init();

  </script>

  <script src="treine-sketch.js"></script>
  
</body>
</html>
